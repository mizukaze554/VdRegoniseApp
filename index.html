<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Optimized Object Detection</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; user-select:none; }
    #container { position:relative; height:70vh; max-width:100vw; margin:2vh auto; background:#111; border-radius:12px; overflow:hidden; }
    video, canvas { height:100%; width:auto; max-width:100vw; object-fit:cover; border-radius:12px; }
    #fabContainer { position:fixed; bottom:5%; right:5%; display:flex; flex-direction:column; gap:12px; z-index:20; }
    .fab { width:clamp(60px,15vw,90px); height:clamp(60px,15vw,90px); font-size:clamp(22px,6vw,36px); border-radius:50%; display:flex; justify-content:center; align-items:center; color:#fff; box-shadow:0 8px 15px rgba(0,0,0,0.25); cursor:pointer; transition:background-color 0.2s ease; }
    .fab:hover { filter:brightness(1.1); }
    #fabDetect { background:#2563eb; } #fabSingle { background:#16a34a; } #fabSwitch { background:#d97706; } #fabStop { background:#dc2626; }
    .toast { position:fixed; bottom:10%; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:0.5rem 1rem; border-radius:8px; opacity:0; transition:opacity 0.3s ease; pointer-events:none; z-index:30; }
    .toast.show { opacity:0.9; }
  </style>
</head>
<body>
  <div id="container">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="fabContainer">
    <button id="fabDetect" class="fab" title="Toggle Continuous Detection">üîÑ</button>
    <button id="fabSingle" class="fab" title="Single Frame Detect">üéØ</button>
    <button id="fabSwitch" class="fab" title="Switch Camera">üîÑüì∑</button>
    <button id="fabStop" class="fab" title="Stop Camera">‚èπÔ∏è</button>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');

    const fabDetect = document.getElementById('fabDetect');
    const fabSingle = document.getElementById('fabSingle');
    const fabSwitch = document.getElementById('fabSwitch');
    const fabStop = document.getElementById('fabStop');
    const toast = document.getElementById('toast');

    let model, detecting = false, cameraActive = false, facingMode = 'environment';
    let lastTime = 0, dynamicSkip = 0, apiMode = false;

    const showToast = (msg) => {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1000);
    };

    async function startCamera() {
      stopCamera();
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode }, audio:false })
          .catch(() => navigator.mediaDevices.getUserMedia({ video:true }));
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = r);
        resizeCanvas();
        cameraActive = true;
      } catch (err) {
        showToast(`Camera error: ${err.message}`);
      }
    }

    function resizeCanvas() {
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
    }

    function stopCamera() {
      if (!cameraActive) return;
      video.srcObject.getTracks().forEach(t => t.stop());
      cameraActive = false;
      detecting = false;
      ctx.clearRect(0,0,overlay.width,overlay.height);
      showToast('Camera stopped');
    }

    function draw(preds, fps) {
      ctx.clearRect(0,0,overlay.width,overlay.height);
      preds.forEach(p => {
        if (p.score < 0.5) return;
        const [x, y, w, h] = p.bbox.map(v => v|0);
        ctx.strokeStyle = '#0FAD4E'; ctx.lineWidth = 2;
        ctx.strokeRect(x, y, w, h);
        ctx.fillStyle = '#0FAD4E';
        ctx.font = `${Math.max(14, overlay.width * 0.02)|0}px sans-serif`;
        ctx.fillText(`${p.class} ${(p.score*100)|0}%`, x, y > 20 ? y-5 : y+18);
      });
      if (fps !== undefined) {
        ctx.fillStyle = '#fff';
        ctx.font = `${Math.max(12, overlay.width * 0.015)|0}px monospace`;
        ctx.fillText(`${fps} fps`, 10, 20);
      }
    }

    async function detectOnce() {
      if (!model || !cameraActive) return;
      const preds = await model.detect(video);
      draw(preds);
    }

    async function detectLoop(time) {
      if (!detecting || !model || !cameraActive) return;

      const start = performance.now();
      await detectOnce();
      const duration = performance.now() - start;
      const fps = (1000 / (time - lastTime))|0;
      lastTime = time;

      // dynamic throttle: aim for ~15‚Äì20fps
      await new Promise(r => setTimeout(r, Math.max(0, 50 - duration)));

      draw([], fps); // preserve fps readout
      requestAnimationFrame(detectLoop);
    }

    async function switchCamera() {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      await startCamera();
      if (detecting) requestAnimationFrame(detectLoop);
      showToast(`Switched to ${facingMode==='environment'?'Back':'Front'} camera`);
    }

    fabDetect.onclick = () => {
      detecting = !detecting;
      if (detecting) {
        requestAnimationFrame(detectLoop);
        showToast('Continuous detection ON');
      } else showToast('Continuous detection OFF');
    };
    fabSingle.onclick = () => { detectOnce(); showToast('Single detect'); };
    fabSwitch.onclick = switchCamera;
    fabStop.onclick = () => { stopCamera(); showToast('Camera stopped'); };

    window.addEventListener('resize', () => { if (cameraActive) resizeCanvas(); });

    (async () => {
      showToast('Loading model...');
      model = await cocoSsd.load({ base: 'mobilenet_v2' }); // lightweight
      await startCamera();
      detecting = true;
      requestAnimationFrame(detectLoop);
      showToast('Model ready & detection started');
    })();
  </script>
</body>
</html>
